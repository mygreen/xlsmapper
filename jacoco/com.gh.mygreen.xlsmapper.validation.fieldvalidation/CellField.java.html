<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CellField.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">XlsMapper</a> &gt; <a href="index.source.html" class="el_package">com.gh.mygreen.xlsmapper.validation.fieldvalidation</a> &gt; <span class="el_source">CellField.java</span></div><h1>CellField.java</h1><pre class="source lang-java linenums">package com.gh.mygreen.xlsmapper.validation.fieldvalidation;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import com.gh.mygreen.xlsmapper.fieldaccessor.LabelGetterFactory;
import com.gh.mygreen.xlsmapper.fieldaccessor.PositionGetterFactory;
import com.gh.mygreen.xlsmapper.util.ArgUtils;
import com.gh.mygreen.xlsmapper.util.CellPosition;
import com.gh.mygreen.xlsmapper.validation.FieldError;
import com.gh.mygreen.xlsmapper.validation.FieldErrorBuilder;
import com.gh.mygreen.xlsmapper.validation.SheetBindingErrors;


/**
 * 1つの項目（フィールド）に対する入力値チェックをするためのクラス。
 * &lt;p&gt;型変換などにおけるバインドエラーなどはシートの読み込み時に行われます。
 * &lt;p&gt;必須エラーのメッセージキーは、「fieldError.required」。
 *
 * @version 0.5
 * @author T.TSUCHIE
 * @param &lt;T&gt; チェック対象の値のタイプ
 *
 */
public class CellField&lt;T&gt; {

<span class="fc" id="L31">    private static final PositionGetterFactory positionGetterFactory = new PositionGetterFactory();</span>
<span class="fc" id="L32">    private static final LabelGetterFactory labelGetterFactory = new LabelGetterFactory();</span>

    private final SheetBindingErrors&lt;?&gt; errors;

    /**
     * フィールドの名称
     */
    private final String fieldName;

    /**
     * フィールドが定義されているBeanクラスのインスタンス
     */
    private Object beanObj;

    /**
     * フィールドの値
     */
    private T fieldValue;

    /**
     * フィールドのJavaBean上のパス
     */
    private String fieldPath;

    /**
     * セルの位置情報。
     * Beanに定義されたプロパティ情報から取得する。
     * 定義されていない場合は、nullが設定される。
     */
    private CellPosition position;

    /**
     * セルのラベル情報
     * Beanに定義されたプロパティ情報から取得する。
     * 定義されていない場合は、nullが設定される。
     */
    private String label;

    /**
     * 必須かどうか
     */
    private boolean required;

    private List&lt;FieldValidator&lt;T&gt;&gt; validators;

    private FieldFormatter&lt;T&gt; formatter;

    private Class&lt;T&gt; fieldType;

    /**
     * 指定されたフィールドの名称に対応するオブジェクトを構築します。
     * @param fieldName フィールドの名称。現在のBeanに対するフィールドの相対パスを指定します。
     * @param errors エラー情報
     */
<span class="fc" id="L86">    public CellField(final String fieldName, final SheetBindingErrors&lt;?&gt; errors) {</span>

<span class="fc" id="L88">        ArgUtils.notEmpty(fieldName, &quot;fieldName&quot;);</span>
<span class="fc" id="L89">        ArgUtils.notNull(errors, &quot;errors&quot;);</span>

<span class="fc" id="L91">        this.fieldName = fieldName;</span>
<span class="fc" id="L92">        this.errors = errors;</span>

<span class="fc" id="L94">        init();</span>
<span class="fc" id="L95">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    private void init() {

<span class="fc" id="L100">        this.beanObj = errors.getValue();</span>
<span class="fc" id="L101">        this.fieldValue = (T)errors.getFieldValue(fieldName);</span>
<span class="fc" id="L102">        this.fieldType = (Class&lt;T&gt;)errors.getFieldType(fieldName);</span>
<span class="fc" id="L103">        this.fieldPath = errors.buildFieldPath(fieldName);</span>

<span class="fc" id="L105">        Optional&lt;CellPosition&gt; position = positionGetterFactory.create(beanObj.getClass(), fieldName)</span>
<span class="fc" id="L106">                .map(getter -&gt; getter.get(beanObj)).orElse(Optional.empty());</span>
<span class="fc" id="L107">        position.ifPresent(p -&gt; setPosition(p));</span>

<span class="fc" id="L109">        Optional&lt;String&gt; label = labelGetterFactory.create(beanObj.getClass(), fieldName)</span>
<span class="fc" id="L110">                .map(getter -&gt; getter.get(beanObj)).orElse(Optional.empty());</span>
<span class="fc" id="L111">        label.ifPresent(l -&gt; setLabel(l));</span>

<span class="fc" id="L113">        this.required = false;</span>
<span class="fc" id="L114">        this.validators = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L116">        this.formatter = errors.findFieldFormatter(fieldName, fieldType);</span>
<span class="fc" id="L117">    }</span>

    /**
     * 値が必須かの設定を行う。
     * @param required 必須チェックを行いたい場合、「true」を設定する。
     * @return 自身のインスタンス。メソッドチェーンで記述する。
     */
    public CellField&lt;T&gt; setRequired(final boolean required) {
<span class="fc" id="L125">        this.required = required;</span>
<span class="fc" id="L126">        return this;</span>
    }

    /**
     * 値が必須かチェックを行うかどうか。
     * @return true: 必須入力チェックを行う。
     *               初期値は、非必須（オプション）です。
     */
    public boolean isRequired() {
<span class="fc" id="L135">        return required;</span>
    }

    /**
     * {@link FieldValidator} を追加する。
     * @param validator validatorのインスタンス。
     * @return 自身のインスタンス。
     * @throws NullPointerException validator is null.
     */
    public CellField&lt;T&gt; add(final FieldValidator&lt;T&gt; validator) {
<span class="fc" id="L145">        ArgUtils.notNull(validator, &quot;validator&quot;);</span>
<span class="fc" id="L146">        this.validators.add(validator);</span>

<span class="fc" id="L148">        return this;</span>
    }

    /**
     * 複数の{@link FieldValidator} を追加する。
     * @param validators 複数のvalidatorのインスタンス。
     * @return 自身のインスタンス。
     * @throws NullPointerException validator is null.
     */
    public CellField&lt;T&gt; add(final List&lt;FieldValidator&lt;T&gt;&gt; validators) {

<span class="fc bfc" id="L159" title="All 2 branches covered.">        if(validators.isEmpty()) {</span>
<span class="fc" id="L160">            return this;</span>
        }

<span class="fc bfc" id="L163" title="All 2 branches covered.">        for(FieldValidator&lt;T&gt; validator : validators) {</span>
<span class="fc" id="L164">            add(validator);</span>
<span class="fc" id="L165">        }</span>
<span class="fc" id="L166">        return this;</span>
    }

    /**
     * 現在の{@link FieldValidator}を取得する。
     * @return 現在設定されている{@link FieldValidator}。
     */
    public List&lt;FieldValidator&lt;T&gt;&gt; getValidators() {
<span class="fc" id="L174">        return validators;</span>
    }

    /**
     * グループなどのヒントを指定して、入力値の検証を行う。
     * &lt;p&gt;判定結果は、{@link #hasErrors()}で確認します。&lt;/p&gt;
     * &lt;p&gt;型変換エラーなどが既に存在するときには、処理は終了します。&lt;/p&gt;
     *
     * @param groups 検証するときのヒントとなるグループ。
     * @return 自身のインスタンス。
     */
    public CellField&lt;T&gt; validate(final Class&lt;?&gt;... groups) {

        // 既に型変換エラーなどがある場合、値が設定されていないため処理を終了します。
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if(hasErrors()) {</span>
<span class="nc" id="L189">            return this;</span>
        }

        // 必須チェック
<span class="fc bfc" id="L193" title="All 2 branches covered.">        if(!validateForRequired()) {</span>
<span class="fc" id="L194">            return this;</span>
        }

<span class="fc" id="L197">        final List&lt;Class&lt;?&gt;&gt; hints = Arrays.asList(groups);</span>

<span class="pc bpc" id="L199" title="1 of 4 branches missed.">        if(getValidators() != null &amp;&amp; !getValidators().isEmpty()) {</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">            for(FieldValidator&lt;T&gt; validator : getValidators()) {</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">                if(!validator.validate(this, hints)) {</span>
<span class="fc" id="L202">                    return this;</span>
                }
<span class="fc" id="L204">            }</span>
        }

<span class="fc" id="L207">        return this;</span>

    }

    /**
     * 必須エラーのメッセージキーを取得する。
     * &lt;p&gt;キー名は、「fieldError.required」。
     * @return
     */
    protected String getMessageKeyRequired() {
<span class="fc" id="L217">        return &quot;cellFieldError.required&quot;;</span>
    }

    /**
     * 必須チェックを行う。
     * @return trueの場合、必須エラーでない。
     */
    protected boolean validateForRequired() {

<span class="fc bfc" id="L226" title="All 4 branches covered.">        if(isRequired() &amp;&amp; isInputEmpty()) {</span>
<span class="fc" id="L227">            errors.createFieldError(fieldName, getMessageKeyRequired())</span>
<span class="fc" id="L228">                .address(getPosition())</span>
<span class="fc" id="L229">                .label(getLabel())</span>
<span class="fc" id="L230">                .variables(&quot;validatedValue&quot;, getValue())</span>
<span class="fc" id="L231">                .buildAndAddError();</span>
<span class="fc" id="L232">            return false;</span>
        }

<span class="fc" id="L235">        return true;</span>

    }

    /**
     * エラーを追加する。
     * @param errorCode エラーコード
     */
    public void rejectValue(final String errorCode) {
<span class="nc" id="L244">        rejectValue(errorCode, Collections.emptyMap());</span>
<span class="nc" id="L245">    }</span>

    /**
     * エラーを追加する
     * @param errorCode エラコード
     * @param variables エラーメッセージ中の変数
     */
    public void rejectValue(final String errorCode, final Map&lt;String, Object&gt; variables) {

<span class="fc" id="L254">        final String codes[] = errors.generateMessageCodes(errorCode, fieldPath, fieldType);</span>

<span class="fc" id="L256">        final FieldError error = new FieldErrorBuilder(errors.getObjectName(), fieldPath, codes)</span>
<span class="fc" id="L257">            .sheetName(errors.getSheetName())</span>
<span class="fc" id="L258">            .rejectedValue(fieldValue)</span>
<span class="fc" id="L259">            .variables(variables)</span>
<span class="fc" id="L260">            .address(position)</span>
<span class="fc" id="L261">            .label(label)</span>
<span class="fc" id="L262">            .build();</span>

<span class="fc" id="L264">        errors.addError(error);</span>
<span class="fc" id="L265">    }</span>

    /**
     * フィールドの値が空かどうか。
     * &lt;p&gt;値がnullまたは、文字列の場合空文字のとき、空と判定する。
     * @return trueの場合、値は空。
     */
    public boolean isInputEmpty() {
<span class="fc bfc" id="L273" title="All 4 branches covered.">        if(fieldValue == null || fieldValue.toString().isEmpty()) {</span>
<span class="fc" id="L274">            return true;</span>
        }

<span class="fc" id="L277">        return false;</span>
    }

    /**
     * フィールドに対してエラーが存在するかどうか。
     * @return trueの場合、エラーが存在する。
     */
    public boolean hasErrors() {
<span class="fc" id="L285">        return errors.hasFieldErrors(fieldName);</span>
    }

    /**
     * フィールドに対してエラーが存在しなかどうか。
     * @return trueの場合、エラーが存在しない。
     */
    public boolean hasNotErrors() {
<span class="nc bnc" id="L293" title="All 2 branches missed.">        return !hasErrors();</span>
    }

    /**
     * エラー情報を取得する。
     * @return エラー情報
     */
    public SheetBindingErrors&lt;?&gt; getBindingErrors() {
<span class="fc" id="L301">        return errors;</span>
    }

    /**
     * フィールドの名称を取得する
     * @return フィールドの名称
     */
    public String getFieldName() {
<span class="fc" id="L309">        return fieldName;</span>
    }

    /**
     * フィールドの値を取得する。
     * @return フィールドの値。
     */
    public T getValue() {
<span class="fc" id="L317">        return fieldValue;</span>
    }

    /**
     * フィールドのクラスタイプを取得する。
     * @return クラスタイプ
     */
    public Class&lt;T&gt; getType() {
<span class="fc" id="L325">        return fieldType;</span>
    }

    /**
     * フィールドのJavaBean上のパスを取得する。
     * @return フィールドのJavaBean上のパス
     */
    public String getFieldPath() {
<span class="nc" id="L333">        return fieldPath;</span>
    }

    /**
     * セルの位置情報を取得します。
     * &lt;p&gt;位置情報の取得用のフィールドやメソッドがbeanに定義されている場合は、コンストラクタの呼び出し時に設定されています。&lt;/p&gt;
     * @return 自身のインスタンス。
     */
    public CellPosition getPosition() {
<span class="fc" id="L342">        return position;</span>
    }

    /**
     * セルの位置情報を設定します。
     * @param position セルの位置情報
     */
    public void setPosition(CellPosition position) {
<span class="fc" id="L350">        this.position = position;</span>
<span class="fc" id="L351">    }</span>

    /**
     * セルのラベル情報を取得します。
     * &lt;p&gt;ラベル情報の取得用のフィールドやメソッドがbeanに定義されている場合は、コンストラクタの呼び出し時に設定されています。&lt;/p&gt;
     * @return 自身のインスタンス。
     */
    public String getLabel() {
<span class="fc" id="L359">        return label;</span>
    }

    /**
     * セルのラベル情報を設定します。
     * @param label セルのラベル情報
     */
    public void setLabel(String label) {
<span class="fc" id="L367">        this.label = label;</span>
<span class="fc" id="L368">    }</span>

    /**
     * フォーマッタを取得する。
     * @return フォーマッタ。
     *         デフォルトでは、フィールドのクラスタイプ、付与されたアノテーションを元にしたもの。
     *
     */
    public FieldFormatter&lt;T&gt; getFormatter() {
<span class="fc" id="L377">        return formatter;</span>
    }

    /**
     * フォーマッタを設定する。
     * @param formatter
     */
    public void setFormatter(FieldFormatter&lt;T&gt; formatter) {
<span class="fc" id="L385">        this.formatter = formatter;</span>
<span class="fc" id="L386">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CellFormulaHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">XlsMapper</a> &gt; <a href="index.source.html" class="el_package">com.gh.mygreen.xlsmapper.cellconverter</a> &gt; <span class="el_source">CellFormulaHandler.java</span></div><h1>CellFormulaHandler.java</h1><pre class="source lang-java linenums">package com.gh.mygreen.xlsmapper.cellconverter;

import java.awt.Point;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

import org.apache.poi.ss.formula.FormulaParseException;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.util.CellReference;

import com.gh.mygreen.xlsmapper.Configuration;
import com.gh.mygreen.xlsmapper.XlsMapperException;
import com.gh.mygreen.xlsmapper.fieldaccessor.FieldAccessor;
import com.gh.mygreen.xlsmapper.localization.MessageBuilder;
import com.gh.mygreen.xlsmapper.util.ArgUtils;
import com.gh.mygreen.xlsmapper.util.CellPosition;
import com.gh.mygreen.xlsmapper.util.Utils;

/**
 * セルの数式を処理する
 *
 * @since 2.0
 * @author T.TSUCHIE
 *
 */
public class CellFormulaHandler {
    
    /**
     * 数式を直接指定している場合
     */
<span class="fc" id="L35">    private Optional&lt;String&gt; formula = Optional.empty();</span>
    
    /**
     * 数式を取得するメソッドを指定している場合
     */
<span class="fc" id="L40">    private Optional&lt;Method&gt; method = Optional.empty();</span>
    
    /**
     * セルの値が設定済みの時に、数式の設定を優先するかどうか。
     */
    private boolean primaryFormula;
    
    /**
     * 数式を直接指定する場合
     * @param formula 数式。EL式で評価可能な形式。
     * @throws IllegalArgumentException {@literal formula == null or empty.}
     */
<span class="fc" id="L52">    public CellFormulaHandler(final String formula) {</span>
<span class="fc" id="L53">        ArgUtils.notEmpty(formula, &quot;formula&quot;);</span>
        
<span class="fc" id="L55">        this.formula = Optional.of(formula);</span>
<span class="fc" id="L56">    }</span>
    
    /**
     * 数式を取得するメソッドを指定する場合
     * @param method 数式を取得するためのメソッド
     * @throws IllegalArgumentException {@literal method == null.}
     */
<span class="fc" id="L63">    public CellFormulaHandler(final Method method) {</span>
<span class="fc" id="L64">        ArgUtils.notNull(method, &quot;method&quot;);</span>
        
<span class="fc" id="L66">        this.method = Optional.of(method);</span>
        
<span class="fc" id="L68">    }</span>
    
    /**
     * セルに数式を設定する
     * @param field フィールド情報
     * @param config システム情報
     * @param cell セル情報
     * @param targetBean 処理対象のフィールドが定義されているクラスのインスタンス。
     * @throws ConversionException 数式の解析に失敗した場合。
     */
    public void handleFormula(final FieldAccessor field, final Configuration config, final Cell cell, final Object targetBean) {
        
<span class="fc" id="L80">        ArgUtils.notNull(field, &quot;field&quot;);</span>
<span class="fc" id="L81">        ArgUtils.notNull(config, &quot;config&quot;);</span>
<span class="fc" id="L82">        ArgUtils.notNull(cell, &quot;cell&quot;);</span>
        
<span class="fc" id="L84">        final String evaluatedFormula = createFormulaValue(config, cell, targetBean);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if(Utils.isEmpty(evaluatedFormula)) {</span>
<span class="fc" id="L86">            cell.setBlank();</span>
<span class="fc" id="L87">            return;</span>
        }
        
        try {
<span class="fc" id="L91">            cell.setCellFormula(evaluatedFormula);</span>
            
<span class="fc" id="L93">        } catch(FormulaParseException e) {</span>
            // 数式の解析に失敗した場合
<span class="fc" id="L95">            String message = MessageBuilder.create(&quot;cell.failParseFormula&quot;)</span>
<span class="fc" id="L96">                    .var(&quot;property&quot;, field.getNameWithClass())</span>
<span class="fc" id="L97">                    .var(&quot;cellAddress&quot;, CellPosition.of(cell).toString())</span>
<span class="fc" id="L98">                    .var(&quot;formula&quot;, evaluatedFormula)</span>
<span class="fc" id="L99">                    .format();</span>
            
<span class="fc" id="L101">            throw new ConversionException(message, e, field.getType());</span>
<span class="fc" id="L102">        }</span>
        
<span class="fc" id="L104">    }</span>
    
    /**
     * Excelの式を組み立てる。
     * @param config システム情報設定
     * @param cell セル情報
     * @param targetBean 処理対象のフィールドが定義されているクラスのインスタンス。
     * @return 組み立てた数式
     */
    public String createFormulaValue(final Configuration config, final Cell cell, final Object targetBean) {
        
<span class="fc bfc" id="L115" title="All 2 branches covered.">        if(formula.isPresent()) {</span>
<span class="fc" id="L116">            final Map&lt;String, Object&gt; vars = new HashMap&lt;&gt;();</span>
<span class="fc" id="L117">            vars.put(&quot;rowIndex&quot;, cell.getRowIndex());</span>
<span class="fc" id="L118">            vars.put(&quot;columnIndex&quot;, cell.getColumnIndex());</span>
<span class="fc" id="L119">            vars.put(&quot;rowNumber&quot;, cell.getRowIndex()+1);</span>
<span class="fc" id="L120">            vars.put(&quot;columnNumber&quot;, cell.getColumnIndex()+1);</span>
<span class="fc" id="L121">            vars.put(&quot;columnAlpha&quot;, CellReference.convertNumToColString(cell.getColumnIndex()));</span>
<span class="fc" id="L122">            vars.put(&quot;address&quot;, CellPosition.of(cell).formatAsString());</span>
<span class="fc" id="L123">            vars.put(&quot;targetBean&quot;, targetBean);</span>
<span class="fc" id="L124">            vars.put(&quot;cell&quot;, cell);</span>
            
<span class="fc" id="L126">            return config.getFormulaFormatter().interpolate(formula.get(), vars);</span>
            
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        } else if(method.isPresent()) {</span>
            
            // メソッドの引数の組み立て
<span class="fc" id="L131">            final Class&lt;?&gt;[] paramTypes = method.get().getParameterTypes();</span>
<span class="fc" id="L132">            final Object[] paramValues = new Object[paramTypes.length];</span>
            
<span class="fc bfc" id="L134" title="All 2 branches covered.">            for(int i=0; i &lt; paramTypes.length; i++) {</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">                if(Cell.class.isAssignableFrom(paramTypes[i])) {</span>
<span class="fc" id="L136">                    paramValues[i] = cell;</span>
                    
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">                } else if(CellPosition.class.isAssignableFrom(paramTypes[i])) {</span>
<span class="nc" id="L139">                    paramValues[i] = CellPosition.of(cell);</span>
                    
<span class="fc bfc" id="L141" title="All 2 branches covered.">                } else if(Point.class.isAssignableFrom(paramTypes[i])) {</span>
<span class="fc" id="L142">                    paramValues[i] = CellPosition.of(cell).toPoint();</span>
                    
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">                } else if(org.apache.poi.ss.util.CellAddress.class.isAssignableFrom(paramTypes[i])) {</span>
<span class="nc" id="L145">                    paramValues[i] = CellPosition.of(cell).toCellAddress();</span>
                    
<span class="fc bfc" id="L147" title="All 2 branches covered.">                } else if(Sheet.class.isAssignableFrom(paramTypes[i])) {</span>
<span class="fc" id="L148">                    paramValues[i] = cell.getSheet();</span>
                    
<span class="fc bfc" id="L150" title="All 2 branches covered.">                } else if(Configuration.class.isAssignableFrom(paramTypes[i])) {</span>
<span class="fc" id="L151">                    paramValues[i] = config;</span>
                    
                } else {
<span class="fc" id="L154">                    paramValues[i] = null;</span>
                }
            }
            
            try {
<span class="fc" id="L159">                return (String) method.get().invoke(targetBean, paramValues);</span>
                
<span class="nc" id="L161">            } catch (IllegalAccessException | IllegalArgumentException | InvocationTargetException e) {</span>
<span class="nc" id="L162">                final Class&lt;?&gt; targetClass = targetBean.getClass();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                final Throwable t = e.getCause() == null ? e : e.getCause();</span>
<span class="nc" id="L164">                throw new XlsMapperException(</span>
<span class="nc" id="L165">                        String.format(&quot;Fail execute method '%s#%s'.&quot;, targetClass.getName(), method.get().getName()),</span>
                        t);
            }
            
        } else {
            // 数式や対応するメソッドがない場合
<span class="nc" id="L171">            throw new IllegalStateException(&quot;not found for formula or method.&quot;);</span>
        }
        
    }
    
    /**
     * セルの値が設定済みの時に、数式の設定を優先するかどうか。
     */
    public boolean isPrimaryFormula() {
<span class="fc" id="L180">        return primaryFormula;</span>
    }
    
    /**
     * セルの値が設定済みの時に、数式の設定を優先するかどうか。
     * @param primaryFormula 数式の設定を優先するかどうか
     */
    public void setPrimaryFormula(boolean primaryFormula) {
<span class="fc" id="L188">        this.primaryFormula = primaryFormula;</span>
<span class="fc" id="L189">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
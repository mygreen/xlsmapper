<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExpressionLanguageJEXLImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">XlsMapper</a> &gt; <a href="index.source.html" class="el_package">com.gh.mygreen.xlsmapper.expression</a> &gt; <span class="el_source">ExpressionLanguageJEXLImpl.java</span></div><h1>ExpressionLanguageJEXLImpl.java</h1><pre class="source lang-java linenums">package com.gh.mygreen.xlsmapper.expression;

import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.stream.Collectors;

import org.apache.commons.jexl3.JexlBuilder;
import org.apache.commons.jexl3.JexlEngine;
import org.apache.commons.jexl3.JexlExpression;
import org.apache.commons.jexl3.MapContext;
import org.apache.commons.jexl3.introspection.JexlPermissions;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.gh.mygreen.xlsmapper.util.ArgUtils;
import com.gh.mygreen.xlsmapper.util.Utils;

/**
 * 式言語「JEXL」の実装。
 * &lt;p&gt;利用する際には、JEXL v3.3以上のライブラリが必要です。
 * &lt;p&gt;JEXL v3.3から、ELインジェクション対策として、&lt;a href=&quot;https://commons.apache.org/proper/commons-jexl/apidocs/org/apache/commons/jexl3/introspection/JexlPermissions.html)&quot;&gt;JexlPermissions&lt;/a&gt;によるEL式中で参照／実行可能なクラスを制限されます。
 * &lt;p&gt;独自のCellConverter / FiledProcessosrなどを実装しているが場合は、システムプロパティ {@literal xlsmapper.jexlPermissions} で指定することができます。
 *    複数指定する場合はカンマ区切りで指定します。
 * &lt;/p&gt;
 *
 * @version 2.3
 * @since 1.5
 * @author T.TSUCHIE
 *
 */
public class ExpressionLanguageJEXLImpl implements ExpressionLanguage {
    
<span class="fc" id="L35">    private static final Logger logger = LoggerFactory.getLogger(ExpressionLanguageJEXLImpl.class);</span>
    
    /**
     * システムプロパティ - JEXLをRESTRICTモードで使用するかどうかフラグ。
     */
    public static final String PROPERTY_JEXL_RESTRICTED = &quot;xlsmapper.jexlRestricted&quot;;
    
    /**
     * システムプロパティ - JEXLをRESTRICTモードで使用する場合のパーミッションを指定する。
     */
    public static final String PROPERTY_JEXL_PERMISSIONS = &quot;xlsmapper.jexlPermissions&quot;;
    
    /**
     * 本ライブラリでJEXLからアクセス許可するパッケージ指定のパーミッション。
     */
<span class="fc" id="L50">    private static final String[] LIB_PERMISSIONS = </span>
        {&quot;com.gh.mygreen.xlsmapper.*&quot;};
    
    /**
     * 独自のJEXLのパーミッション。
     */
    private static final String[] USER_PERMISSIONS;
    static {
<span class="fc" id="L58">        String value = System.getProperty(PROPERTY_JEXL_PERMISSIONS);</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if(Utils.isNotEmpty(value)) {</span>
<span class="nc" id="L60">            USER_PERMISSIONS = Arrays.stream(value.split(&quot;,&quot;))</span>
<span class="nc" id="L61">                    .map(String::trim)</span>
<span class="nc" id="L62">                    .filter(String::isEmpty)</span>
<span class="nc" id="L63">                    .collect(Collectors.toList())</span>
<span class="nc" id="L64">                    .toArray(new String[0]);</span>
            
        } else {
<span class="fc" id="L67">            USER_PERMISSIONS = new String[] {};</span>
        }
<span class="fc" id="L69">    }</span>
    
    /**
     * JEXLのキャッシュサイズ。
     * &lt;p&gt;キャッシュする式の個数。
     */
    private static final int CACHE_SIZE = 256;
    
    private final JexlEngine jexlEngine;
    
    /**
     * デフォルトのコンストラクタ。
     * &lt;p&gt;パーミッションによる制限を実施する。
     */
    public ExpressionLanguageJEXLImpl() {
<span class="fc" id="L84">        this(Collections.emptyMap(), true);</span>
        
<span class="fc" id="L86">    }</span>
    
    /**
     * JEXLの独自のEL関数とパーミッションを指定するコンストラクタ。
     * &lt;p&gt;関数として{@link CustomFunctions}が登録されており、接頭語 {@literal f:}で呼び出し可能です。
     * 
     * @param userFunctions 独自のEL関数を指定します。keyは接頭語、valueはメソッドが定義されたクラス。
     * @param restricted JEXLをRESTRICTEDモードでパーミッションによる制限を行うかどうか。
     * @param userPermissions JEXLのパーミッション。
     *        詳細は、&lt;a href=&quot;https://commons.apache.org/proper/commons-jexl/apidocs/org/apache/commons/jexl3/introspection/JexlPermissions.html)&quot;&gt;JexlPermissions&lt;/a&gt; を参照。
     */
<span class="fc" id="L97">    public ExpressionLanguageJEXLImpl(final Map&lt;String, Object&gt; userFunctions, final boolean restricted, final String... userPermissions) {</span>
        
        // EL式中で使用可能な関数の登録
<span class="fc" id="L100">        Map&lt;String, Object&gt; functions = new HashMap&lt;&gt;();</span>
<span class="fc" id="L101">        functions.put(&quot;f&quot;, CustomFunctions.class);</span>
        
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if (Utils.isNotEmpty(userFunctions)) {</span>
<span class="nc" id="L104">            functions.putAll(userFunctions);</span>
        }

        final JexlPermissions permissions;
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if(Utils.toBoolean(System.getProperty(PROPERTY_JEXL_RESTRICTED), restricted)) {</span>
            /*
             * EL式で本ライブラリのクラス／メソッドのアクセスを許可する。
             * ・CustomFunctions以外にも、CellConverter / FieldProcessorでも参照するため。
             * ・JEXLv3からサーバーサイド・テンプレート・インジェクション、コマンドインジェクション対策のために、
             *   許可されたクラスしか参照できなくなったため、本ライブラリをEL式から参照可能に許可する。
             */
<span class="fc" id="L115">            String[] concateedUserPermission = Utils.concat(USER_PERMISSIONS, userPermissions);</span>
<span class="fc" id="L116">            permissions = JexlPermissions.RESTRICTED</span>
<span class="fc" id="L117">                    .compose(Utils.concat(LIB_PERMISSIONS, concateedUserPermission));</span>
<span class="fc" id="L118">        } else {</span>
            // パーミッションによる制限を行わない。
<span class="fc" id="L120">            permissions = JexlPermissions.UNRESTRICTED;</span>
        }

<span class="fc" id="L123">        this.jexlEngine = new JexlBuilder()</span>
<span class="fc" id="L124">                .namespaces(functions)</span>
<span class="fc" id="L125">                .permissions(permissions)</span>
<span class="fc" id="L126">                .silent(true)</span>
<span class="fc" id="L127">                .strict(false)  // JEXLv2相当の文法にする。</span>
<span class="fc" id="L128">                .cache(CACHE_SIZE)</span>
<span class="fc" id="L129">                .create();</span>
        
<span class="fc" id="L131">    }</span>
    
    
    /**
     * {@link JexlEngine}を指定するコンストラクタ。
     * @param jexlEngine JEXLの処理エンジン。
     */
<span class="nc" id="L138">    public ExpressionLanguageJEXLImpl(final JexlEngine jexlEngine) {</span>
<span class="nc" id="L139">        this.jexlEngine = jexlEngine;</span>
<span class="nc" id="L140">    }</span>
    
    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public Object evaluate(final String expression, final Map&lt;String, ?&gt; values) {
        
<span class="fc" id="L146">        ArgUtils.notEmpty(expression, &quot;expression&quot;);</span>
<span class="fc" id="L147">        ArgUtils.notNull(values, &quot;values&quot;);</span>
        
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">        if(logger.isDebugEnabled()) {</span>
<span class="fc" id="L150">            logger.debug(&quot;Evaluating JEXL expression: {}&quot;, expression);</span>
        }
        
        try {
<span class="fc" id="L154">            JexlExpression expr = jexlEngine.createExpression(expression);</span>
<span class="fc" id="L155">            return expr.evaluate(new MapContext((Map&lt;String, Object&gt;) values));</span>
            
<span class="fc" id="L157">        } catch(Exception ex) {</span>
<span class="fc" id="L158">            throw new ExpressionEvaluationException(String.format(&quot;Evaluating [%s] script with JEXL failed.&quot;, expression), ex);</span>
        }
    }
    
    /**
     * {@link JexlEngine}を取得する。
     * @return
     */
    public JexlEngine getJexlEngine() {
<span class="nc" id="L167">        return jexlEngine;</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>
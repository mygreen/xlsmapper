<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FieldAccessor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">XlsMapper</a> &gt; <a href="index.source.html" class="el_package">com.gh.mygreen.xlsmapper.fieldaccessor</a> &gt; <span class="el_source">FieldAccessor.java</span></div><h1>FieldAccessor.java</h1><pre class="source lang-java linenums">package com.gh.mygreen.xlsmapper.fieldaccessor;

import java.lang.annotation.Annotation;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Collection;
import java.util.HashMap;
import java.util.Map;
import java.util.NoSuchElementException;
import java.util.Optional;

import com.gh.mygreen.xlsmapper.annotation.XlsArrayColumns;
import com.gh.mygreen.xlsmapper.annotation.XlsMapColumns;
import com.gh.mygreen.xlsmapper.util.ArgUtils;
import com.gh.mygreen.xlsmapper.util.CellPosition;

/**
 * メソッド（setter/getter）とフィールドのアクセスを吸収するクラス。
 * &lt;p&gt;インスタンスは、{@link FieldAccessorFactory}から作成します。&lt;/p&gt;
 *
 * @version 2.0
 * @author T.TSUCHIE
 *
 */
public class FieldAccessor {
    
    /**
     * フィールド（プロパティ）の名称
     */
    String name;
    
    /**
     * フィールドやメソッドが定義されているクラス
     */
    Class&lt;?&gt; declaringClass;
    
    /**
     * フィールドのクラスタイプ
     */
    Class&lt;?&gt; targetType;
    
    /**
     * フィールド情報
     */
<span class="fc" id="L46">    Optional&lt;Field&gt; targetField = Optional.empty();</span>
    
    /**
     * Getterメソッド
     */
<span class="fc" id="L51">    Optional&lt;Method&gt; targetGetter = Optional.empty();</span>
    
    /**
     * Setterメソッド
     */
<span class="fc" id="L56">    Optional&lt;Method&gt; targetSetter = Optional.empty();</span>
    
    /**
     * フィールドのタイプがListや配列の時の要素のクラスタイプ
     */
<span class="fc" id="L61">    Optional&lt;Class&lt;?&gt;&gt; componentType = Optional.empty();</span>
    
    /** 
     * アノテーションの情報
     */
<span class="fc" id="L66">    Map&lt;Class&lt;? extends Annotation&gt;, Annotation&gt; annotationMap = new HashMap&lt;&gt;();</span>
    
    /**
     * 位置情報のSetter
     */
<span class="fc" id="L71">    Optional&lt;PositionSetter&gt; positionSetter = Optional.empty();</span>
    
    /**
     * 位置情報のgetter
     */
<span class="fc" id="L76">    Optional&lt;PositionGetter&gt; positionGetter = Optional.empty();</span>
    
    /**
     * {@link XlsMapColumns}用の位置情報のSetter
     */
<span class="fc" id="L81">    Optional&lt;MapPositionSetter&gt; mapPositionSetter = Optional.empty();</span>
    
    /**
     * {@link XlsArrayColumns}用の位置情報のSetter
     */
<span class="fc" id="L86">    Optional&lt;ArrayPositionSetter&gt; arrayPositionSetter = Optional.empty();</span>
    
    /**
     * ラベル情報のSetter
     */
<span class="fc" id="L91">    Optional&lt;LabelSetter&gt; labelSetter = Optional.empty();</span>
    
    /**
     * ラベル情報のgetter
     */
<span class="fc" id="L96">    Optional&lt;LabelGetter&gt; labelGetter = Optional.empty();</span>
    
    /**
     * {@link XlsMapColumns}用のラベル情報のSetter
     */
<span class="fc" id="L101">    Optional&lt;MapLabelSetter&gt; mapLabelSetter = Optional.empty();</span>
    
    /**
     * {@link XlsArrayColumns}用の位置情報のSetter
     */
<span class="fc" id="L106">    Optional&lt;ArrayLabelSetter&gt; arrayLabelSetter = Optional.empty();</span>
    
<span class="fc" id="L108">    FieldAccessor() {</span>
        
<span class="fc" id="L110">    }</span>
    
    /**
     * フィールドとメソッドに同じアノテーションが付与されているときに重複を除外するための判定に使用する。
     * そのため、{@link FieldAccessor#getNameWithClass()}が等しいかで判定します。
     * 
     */
    @Override
    public boolean equals(final Object obj) {
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        if(this == obj) {</span>
<span class="nc" id="L120">            return true;</span>
        }
        
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        if(!(obj instanceof FieldAccessor)) {</span>
<span class="nc" id="L124">            return false;</span>
        }
        
<span class="fc" id="L127">        final FieldAccessor target = (FieldAccessor)obj;</span>
        
        // クラス名#フィールドの比較
<span class="fc bfc" id="L130" title="All 2 branches covered.">        if(!getNameWithClass().equals(target.getNameWithClass())) {</span>
<span class="fc" id="L131">            return false;</span>
        }
        
<span class="fc" id="L134">        return true;</span>
    }
    
    /**
     * 読み込み可能かどうか判定します。
     * @return フィールドまたはgetterメソッドが存在する場合にtrueを返します。
     */
    public boolean isReadable() {
        
<span class="pc bpc" id="L143" title="3 of 4 branches missed.">        return targetField.isPresent() || targetGetter.isPresent();</span>
        
    }
    
    /**
     * 書き込み可能かどうか判定します。
     * @return フィールドまたはsetterメソッドが存在する場合にtrueを返します。
     */
    public boolean isWritable() {
        
<span class="pc bpc" id="L153" title="3 of 4 branches missed.">        return targetField.isPresent() || targetSetter.isPresent();</span>
    }
    
    /**
     * オブジェクトのフィールドの値を取得します。
     * &lt;p&gt;getterが存在する場合は、getterメソッド経由で取得します。&lt;/p&gt;
     * @param targetObj オブジェクト（インスタンス）
     * @return フィールドの値。
     * @throws IllegalArgumentException {@literal targetObj == null.}
     * @throws FieldAccessException {@literal 値の取得に失敗した場合。}
     */
    public Object getValue(final Object targetObj) {
        
<span class="fc" id="L166">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
        
<span class="fc bfc" id="L168" title="All 2 branches covered.">        if(targetGetter.isPresent()) {</span>
            try {
<span class="fc" id="L170">                return targetGetter.get().invoke(targetObj);</span>
<span class="nc" id="L171">            } catch (IllegalAccessException | IllegalArgumentException | InvocationTargetException e) {</span>
<span class="nc" id="L172">                throw new FieldAccessException(this, &quot;fail getter value&quot;, e);</span>
            }
            
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        } else if(targetField.isPresent()) {</span>
            try {
<span class="fc" id="L177">                return targetField.get().get(targetObj);</span>
<span class="nc" id="L178">            } catch (IllegalArgumentException | IllegalAccessException e) {</span>
<span class="nc" id="L179">                throw new FieldAccessException(this, &quot;fail get field value&quot;, e);</span>
            }
            
        } else {
<span class="nc" id="L183">            throw new FieldAccessException(this, &quot;not found getter method or field.&quot;);</span>
        }
        
    }
    
    /**
     * オブジェクトのフィールドに値を設定する。
     * &lt;p&gt;setterが存在する場合は、setterメソッド経由で値を設定します。&lt;/p&gt;
     * @param targetObj オブジェクト（インスタンス）
     * @param value フィールドの値。
     * @throws IllegalArgumentException {@literal targetObj == null.}
     * @throws FieldAccessException {@literal 値の設定に失敗した場合。}
     * 
     */
    public void setValue(final Object targetObj, final Object value) {
<span class="fc" id="L198">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
        
<span class="fc bfc" id="L200" title="All 2 branches covered.">        if(targetSetter.isPresent()) {</span>
            try {
<span class="fc" id="L202">                targetSetter.get().invoke(targetObj, value);</span>
<span class="nc" id="L203">            } catch (IllegalAccessException | IllegalArgumentException | InvocationTargetException e) {</span>
<span class="nc" id="L204">                throw new FieldAccessException(this, &quot;fail setter value&quot;, e);</span>
<span class="fc" id="L205">            }</span>
            
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        } else if(targetField.isPresent()) {</span>
            try {
<span class="fc" id="L209">                targetField.get().set(targetObj, value);</span>
                
<span class="nc" id="L211">            } catch (IllegalArgumentException | IllegalAccessException e) {</span>
<span class="nc" id="L212">                throw new FieldAccessException(this, &quot;fail setter field value&quot;, e);</span>
<span class="fc" id="L213">            }</span>
            
        } else {
<span class="nc" id="L216">            throw new FieldAccessException(this, &quot;not found setter method or field.&quot;);</span>
        }
<span class="fc" id="L218">    }</span>
    
    /**
     * フィールドがマップ形式の場合に、キーを指定して値を取得する。
     * 
     * @param key マップキーの値
     * @param targetObj オブジェクト（インスタンス）
     * @return マップの値
     * @throws IllegalArgumentException {@literal targetObj == null.}
     * @throws IllegalStateException {@literal フィールドのタイプがMap出ない場合}
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public Object getValueOfMap(final Object key, final Object targetObj) {
<span class="fc" id="L231">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
        
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if(!Map.class.isAssignableFrom(targetType)) {</span>
<span class="nc" id="L234">            throw new IllegalStateException(&quot;this method cannot call Map. This target type is &quot; + targetType.getName());</span>
        }
        
<span class="fc" id="L237">        final Map&lt;Object, Object&gt; map = (Map&lt;Object, Object&gt;) getValue(targetObj);</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">        if(map == null) {</span>
<span class="fc" id="L239">            return null;</span>
        }
        
<span class="fc" id="L242">        return map.get(key);</span>
        
    }
    
    /**
     * アノテーションの一覧を取得します。
     * @return 付与されているアノテーションの一覧
     */
    public Collection&lt;? extends Annotation&gt; getAnnotations() {
<span class="nc" id="L251">        return annotationMap.values();</span>
    }
    
    /**
     * 指定したアノテーションを持つか判定します。
     * @param annoClass アノテーションのクラスタイプ。
     * @return trueの場合、アノテーションを持ちます。
     */
    public &lt;A extends Annotation&gt; boolean hasAnnotation(final Class&lt;A&gt; annoClass) {
<span class="fc" id="L260">        return annotationMap.containsKey(annoClass);</span>
    }
    
    /**
     * タイプを指定して、アノテーションを取得する。
     * @param annoClass アノテーションのクラスタイプ。
     * @return 存在しない場合、空を返します。
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;A extends Annotation&gt; Optional&lt;A&gt; getAnnotation(final Class&lt;A&gt; annoClass) {
<span class="fc" id="L270">        return Optional.ofNullable((A)annotationMap.get(annoClass));</span>
    }
    
    /**
     * フィールドの名称を取得します。
     * @return フィールドの名称
     */
    public String getName() {
<span class="fc" id="L278">        return name;</span>
    }
    
    /**
     * フィールドのタイプを取得します。
     * @return フィールドのクラスタイプ
     */
    public Class&lt;?&gt; getType() {
        
<span class="fc" id="L287">        return targetType;</span>
    }
    
    /**
     * フィールドのタイプがListや配列の時の要素のGenericsのクラスタイプを取得します。
     * @return クラスタイプ。
     * @throws NoSuchElementException {@literal Genericsの指定がないとき、またはサポートしていないクラスタイプの場合}
     */
    public Class&lt;?&gt; getComponentType() {
<span class="fc" id="L296">        return componentType.get();</span>
    }
    
    /**
     * フィールドタイプがListや配列の時の要素のGenericsのクラスタイプかどうか。
     * @return trueの場合、Listや配列の時の要素のGenericsのクラスタイプの場合。
     */
    public boolean isComponentType() {
<span class="fc" id="L304">        return componentType.isPresent();</span>
    }
    
    /**
     * フィールド情報を取得します。
     * @return フィールドを持たない場合は、空を返します。
     */
    public Optional&lt;Field&gt; getField() {
<span class="fc" id="L312">        return targetField;</span>
    }
    
    /**
     * Getterメソッドを取得します。
     * @return getterメソッドを持たない場合は、空を返します。
     */
    public Optional&lt;Method&gt; getGetter() {
<span class="fc" id="L320">        return targetGetter;</span>
    }
    
    /**
     * Setterメソッドを取得します。
     * @return setterメソッドを持たない場合は、空を返します。
     */
    public Optional&lt;Method&gt; getSetter() {
<span class="fc" id="L328">        return targetSetter;</span>
    }
    
    /**
     * フィールドが定義されているクラス情報を取得します。
     * @return フィールドが定義されているクラス情報
     */
    public Class&lt;?&gt; getDeclaringClass() {
<span class="fc" id="L336">        return declaringClass;</span>
    }
    
    /**
     * クラス名付きのフィールド名称を取得する。
     * @since 1.4
     * @return {@literal &lt;クラス名#フィールド名&gt;}
     */
    public String getNameWithClass() {
<span class="fc" id="L345">        return getDeclaringClass().getName() + &quot;#&quot; + getName();</span>
    }
    
    /**
     * 位置情報を設定します。
     * &lt;p&gt;位置情報を保持するフィールドがない場合は、処理はスキップされます。&lt;/p&gt;
     * @param targetObj フィールドが定義されているクラスのインスタンス
     * @param position 位置情報
     * @throws IllegalArgumentException {@literal targetObj == null or position == null}
     */
    public void setPosition(final Object targetObj, final CellPosition position) {
        
<span class="fc" id="L357">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
<span class="fc" id="L358">        ArgUtils.notNull(position, &quot;position&quot;);</span>
        
<span class="fc" id="L360">        positionSetter.ifPresent(setter -&gt; setter.set(targetObj, position));</span>
<span class="fc" id="L361">    }</span>
    
    /**
     * 位置情報を取得します。
     * @param targetObj フィールドが定義されているクラスのインスタンス
     * @return 位置情報を保持するフィールドがない場合や、値が設定されていないときは空を返します。
     * @throws IllegalArgumentException {@literal targetObj == null or position == null}
     */
    public Optional&lt;CellPosition&gt; getPosition(final Object targetObj) {
<span class="nc" id="L370">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
        
<span class="nc" id="L372">        return positionGetter.map(getter -&gt; getter.get(targetObj)).orElse(Optional.empty());</span>
    }
    
    /**
     * {@link XlsMapColumns}フィールド用の位置情報を設定します。
     * &lt;p&gt;位置情報を保持するフィールドがない場合は、処理はスキップされます。&lt;/p&gt;
     * 
     * @param targetObj フィールドが定義されているクラスのインスタンス
     * @param position 位置情報
     * @param key マップのキー
     * @throws IllegalArgumentException {@literal targetObj == null or position == null or key == null}
     * @throws IllegalArgumentException {@literal key is empty.}
     */
    public void setMapPosition(final Object targetObj, final CellPosition position, final String key) {
        
<span class="fc" id="L387">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
<span class="fc" id="L388">        ArgUtils.notNull(position, &quot;position&quot;);</span>
<span class="fc" id="L389">        ArgUtils.notEmpty(key, &quot;key&quot;);</span>
        
<span class="fc" id="L391">        mapPositionSetter.ifPresent(setter -&gt; setter.set(targetObj, position, key));</span>
        
<span class="fc" id="L393">    }</span>
    
    /**
     * {@link XlsArrayColumns}フィールド用の位置情報を設定します。
     * &lt;p&gt;位置情報を保持するフィールドがない場合は、処理はスキップされます。&lt;/p&gt;
     * 
     * @param targetObj フィールドが定義されているクラスのインスタンス
     * @param position 位置情報
     * @param index インデックスのキー。0以上を指定します。
     * @throws IllegalArgumentException {@literal targetObj == null or position == null}
     * @throws IllegalArgumentException {@literal index &lt; 0}
     */
    public void setArrayPosition(final Object targetObj, final CellPosition position, final int index) {
        
<span class="fc" id="L407">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
<span class="fc" id="L408">        ArgUtils.notNull(position, &quot;position&quot;);</span>
<span class="fc" id="L409">        ArgUtils.notMin(index, 0, &quot;index&quot;);</span>
        
<span class="fc" id="L411">        arrayPositionSetter.ifPresent(setter -&gt; setter.set(targetObj, position, index));</span>
        
<span class="fc" id="L413">    }</span>
    
    /**
     * ラベル情報を設定します。
     * &lt;p&gt;ラベル情報を保持するフィールドがない場合は、処理はスキップされます。&lt;/p&gt;
     * @param targetObj フィールドが定義されているクラスのインスタンス
     * @param label ラベル情報
     * @throws IllegalArgumentException {@literal targetObj == null or label == null}
     * @throws IllegalArgumentException {@literal label is empty}
     */
    public void setLabel(final Object targetObj, final String label) {
        
<span class="fc" id="L425">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
<span class="fc" id="L426">        ArgUtils.notEmpty(label, &quot;label&quot;);</span>
        
<span class="fc" id="L428">        labelSetter.ifPresent(setter -&gt; setter.set(targetObj, label));</span>
<span class="fc" id="L429">    }</span>
    
    /**
     * ラベル情報を取得します。
     * @param targetObj フィールドが定義されているクラスのインスタンス
     * @return ラベル情報を保持するフィールドがない場合や、値が設定されていないときは空を返します。
     * @throws IllegalArgumentException {@literal targetObj == null or label == null}
     */
    public Optional&lt;String&gt; getLabel(final Object targetObj) {
<span class="nc" id="L438">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
        
<span class="nc" id="L440">        return labelGetter.map(getter -&gt; getter.get(targetObj)).orElse(Optional.empty());</span>
    }
    
    /**
     * {@link XlsMapColumns}フィールド用のラベル情報を設定します。
     * &lt;p&gt;ラベル情報を保持するフィールドがない場合は、処理はスキップされます。&lt;/p&gt;
     * 
     * @param targetObj フィールドが定義されているクラスのインスタンス
     * @param label ラベル情報
     * @param key マップのキー
     * @throws IllegalArgumentException {@literal targetObj == null or label == null or key == null}
     * @throws IllegalArgumentException {@literal label or key is empty.}
     */
    public void setMapLabel(final Object targetObj, final String label, final String key) {
        
<span class="fc" id="L455">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
<span class="fc" id="L456">        ArgUtils.notEmpty(label, &quot;label&quot;);</span>
<span class="fc" id="L457">        ArgUtils.notEmpty(key, &quot;key&quot;);</span>
        
<span class="fc" id="L459">        mapLabelSetter.ifPresent(setter -&gt; setter.set(targetObj, label, key));</span>
        
<span class="fc" id="L461">    }</span>
    
    /**
     * {@link XlsArrayColumns}フィールド用のラベル情報を設定します。
     * &lt;p&gt;ラベル情報を保持するフィールドがない場合は、処理はスキップされます。&lt;/p&gt;
     * 
     * @param targetObj フィールドが定義されているクラスのインスタンス
     * @param label ラベル情報
     * @param index インデックスのキー。0以上を指定します。
     * @throws IllegalArgumentException {@literal targetObj == null or label == null.}
     * @throws IllegalArgumentException {@literal label or index &lt; 0}
     */
    public void setArrayLabel(final Object targetObj, final String label, final int index) {
        
<span class="fc" id="L475">        ArgUtils.notNull(targetObj, &quot;targetObj&quot;);</span>
<span class="fc" id="L476">        ArgUtils.notEmpty(label, &quot;label&quot;);</span>
<span class="fc" id="L477">        ArgUtils.notMin(index, 0, &quot;index&quot;);</span>
        
<span class="fc" id="L479">        arrayLabelSetter.ifPresent(setter -&gt; setter.set(targetObj, label, index));</span>
        
<span class="fc" id="L481">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>